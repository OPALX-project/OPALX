Option, ECHO=FALSE;
Option, TFS=FALSE;
Option, PSDUMPFREQ=20;

Title,string="OPAL External field test";

Edes=1.0;
gamma=(Edes+PMASS)/PMASS;
beta=sqrt(1-(1/gamma^2));
gambet=gamma*beta;
P0 = gamma*beta*PMASS;
brho = (PMASS*1.0e9*gambet) / CLIGHT;
value,{gamma,brho,Edes,beta,gambet};

// L:        physical element lenght (real)
// KS:       field scaling factor (real)
// FMAPFN:   field file name (string)
// ELEMEDGE: physical start of the element on the floor (real)
//

FINEG_MSL10: Solenoid, L=0.12, KS=0.31250, FMAPFN="FINEG-MSL10.T7", ELEMEDGE=-0.002;

FINLB01_MSL10_1: Solenoid, L=0.1, KS=0.08300, FMAPFN="FINLB01-MSL.T7", ELEMEDGE=0.304;
FINLB01_MSL10_2: Solenoid, L=0.1, KS=-0.0830, FMAPFN="FINLB01-MSL.T7", ELEMEDGE=0.404;

FINLB01_MSL20_1: Solenoid, L=0.1, KS=0.04780, FMAPFN="FINLB01-MSL.T7", ELEMEDGE=0.804;
FINLB01_MSL20_2: Solenoid, L=0.1, KS=-0.0478, FMAPFN="FINLB01-MSL.T7", ELEMEDGE=0.904;

FINLB01_MSL30_1: Solenoid, L=0.1, KS=0.073250, FMAPFN="FINLB01-MSL.T7", ELEMEDGE=1.304;
FINLB01_MSL30_2: Solenoid, L=0.1, KS=-0.07325, FMAPFN="FINLB01-MSL.T7", ELEMEDGE=1.404;

FINLB01_MSL40_1: Solenoid, L=0.1, KS=0.083470, FMAPFN="FINLB01-MSL.T7", ELEMEDGE=1.804;
FINLB01_MSL40_2: Solenoid, L=0.1, KS=-0.08347, FMAPFN="FINLB01-MSL.T7", ELEMEDGE=1.904;

// L:        physical element lenght (real)
// VOLT:     field scaling factor (real)
// FMAPFN:   field file name (string)
// ELEMEDGE: physical start of the element on the floor (real)
// TYPE:     STANDING or TRAVELING wave (string)
// FREQ:     fundamental mode/frequency of the cavity
//

// VOLT=0.9857*IMPACT-T
FINLB01_RACF: RFCavity, L=0.54, VOLT=19.961*1.641907, FMAPFN="FINLB01-RACF.T7", ELEMEDGE=0.069, TYPE="STANDING", FREQ=1498.956, LAG=184.0/360.0;
FINLB01_RACH: RFCavity, L=0.54, VOLT= 6.250*1.641907, FMAPFN="FINLB01-RACH.T7", ELEMEDGE=0.069, TYPE="STANDING", FREQ=4497.536, LAG=104.0/360.0;

FINLB01: Line = (FINLB01_RACF, FINLB01_RACH, 
                 FINLB01_MSL10_1, FINLB01_MSL10_2,
                 FINLB01_MSL20_1, FINLB01_MSL20_2, 
                 FINLB01_MSL30_1, FINLB01_MSL30_2, 
                 FINLB01_MSL40_1, FINLB01_MSL40_2);

// L-Band Structure starts here
// 40 cells in 2\pi/3 mode at 1.5 GHz (rfdata[1-4]); with 4 solenoids on top (1T6.T7)

/*
  FAST=TRUE -> enables fast calculation of electric fields (one FFT + interpolation)
*/

FINLB02_RAC: TravelingWave, L=2.80, VOLT=14.750*30/31, FMAPFN="FINLB02-RAC.T7", ELEMEDGE=2.67066, NUMCELLS=40, MODE=1/3, ACCURACY=39, FREQ=1498.956, LAG=248.0/360.0;

FINLB02_MSLAC10: Solenoid, L=0.5, KS=0.05, FMAPFN="FINLB02-MSLAC.T7", ELEMEDGE=2.454;

FINLB02_MSLAC20: Solenoid, L=0.5, KS=0.05, FMAPFN="FINLB02-MSLAC.T7", ELEMEDGE=3.154;

FINLB02_MSLAC30: Solenoid, L=0.5, KS=0.05, FMAPFN="FINLB02-MSLAC.T7", ELEMEDGE=3.854;

FINLB02_MSLAC40: Solenoid, L=0.5, KS=0.05, FMAPFN="FINLB02-MSLAC.T7", ELEMEDGE=4.554;

FINLB02: Line = (FINLB02_RAC,
                 FINLB02_MSLAC10,
                 FINLB02_MSLAC20,
                 FINLB02_MSLAC30,
                 FINLB02_MSLAC40);

l1:   Line = (FINEG_MSL10,FINLB01,FINLB02);

/*
 We can specity ONE distribution
*/

Dist1:DISTRIBUTION, DISTRIBUTION=gauss,
sigmax=  1.0e-03, sigmapx=1.0e-4, corrx=0.5,
sigmay=  2.0e-03, sigmapy=1.0e-4, corry=-0.5,
sigmat=  3.0e-03, sigmapt=1.0e-4, corrt=0.0;

/*
 We can specity ONE field solver object
*/

Fs1:FIELDSOLVER, FSTYPE=None, MX=16, MY=16, MT=128,
                 PARFFTX=false, PARFFTY=false, PARFFTT=true,
                 BCFFTX=open, BCFFTY=open, BCFFTT=open,
                 BBOXINCR=1.0, GREENSF=INTEGRATED;


beam1: BEAM, PARTICLE=ELECTRON, pc=P0, NPART=5e4, BFREQ=1498.953425154e6, BCURRENT=0.032912, CHARGE=-1;

Select, Line=l1;

track,line=l1, beam=beam1, MAXSTEPS=14226, DT=1.0e-11;
 run, file = "track_output", turns = 1, method = "PARALLEL-T", beam=beam1, fieldsolver=Fs1, distribution=Dist1;
endtrack;
Stop;
