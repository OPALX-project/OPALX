\documentclass[a4paper,11pt]{article}
\usepackage{amsmath}
\usepackage{epstopdf}
\usepackage{amsfonts}
\usepackage{graphicx}
\usepackage{algorithm,algorithmic}
\usepackage{url}
\usepackage{color}
\usepackage{tikz}
\usepackage{multirow}
\usepackage{verbatim}
%\usepackage{hyperref}
\usepackage{float}
\usepackage{geometry}
\usepackage{indentfirst}
\usepackage{amssymb}
%\usepackage{circuitikz}
\usepackage{array} 
\usepackage{appendix}
\usepackage{float}
\usepackage{graphicx}
\usepackage{url}
\usepackage[colorlinks,linkcolor=blue,anchorcolor=blue,citecolor=blue]{hyperref} % hyper reference to contents
\usepackage{algorithm,algorithmic}
\usepackage{tikz}
\usepackage{suffix}
\usetikzlibrary{arrows,shapes,snakes}
\usepackage[retainorgcmds]{IEEEtrantools}
\geometry{left=3.17cm,right=3.17cm,top=2.54cm,bottom=2.54cm}
\pagestyle{empty}

\include{mylatexdefs}

\begin{document}
\begin{center}
{\large Set Up a Dark Current and Multipacting Simulation} \\
Chuan Wang, Andreas Adelmann \\
\today\\
\end{center}
\section{Preparing the geometries}
The dark current and multipacting simulation in \opal\ involve the BoundaryGeometry class which in consequence need triangulated surface mesh file to represent the geometry of RF structures. So the first step to perform a dark current and multipacting simulation is to prepare the triangulated surface mesh file (currently in FEMAXX hdf5 file format). We provide the following two ways to generate a triangulated surface mesh file with FEMAXX hdf5 format.
\subsection{Using Heronion}
Heronion is a frontend, which reads the STEP file, triangulates the surface, tetrahedralizes the volume and stores the surface mesh and/or the volume mesh into FEMAXX input file \cite{heronion}. Heronion is developed by Dr. Benedikt Oswald in AMAS, PSI, based on the well known mesher Tetgen \cite{tetgen}. Some new features for triangulated surface mesh for the dark current and multipacting simulation in \opal\ have been provided in a new version of Heronion, and many more new features will continually be provided in consequence of the need from FEMAXX or the modification of BoundaryGeometry class in \opal\. The way to use Heronion to generate the surface mesh will be shown later after updating the new version of Heronion.
\subsection{Using GMSH}
GMSH is an open source, mesh generator that any linux user can get from its website \cite{gmsh}. The process to generate surface mesh by using GMSH are as follows:
\begin{enumerate}
    \item Get a STEP format file which is usually generated by 3D commercial CAD program, like CATIA, Solidworks, ProE. This STEP file should contains the solid model whose outer surface is the inner surface (i.e., the surface in which the field emission and secondary emission happens) of your RF structure. Put this STEP file in current folder, for example, put the step file (10.stp) of cyclotron cavity in the following folder as:\~{}/Geometry/10.stp   
    \item Under the current folder and in command line type ``gmsh \&" to open the GMSH graphic user interface (GUI). ( The install path of GMSH should have already been added in your .bashrc file ). 
    \item Press ``File$->$Open'' button and choose the ``10.stp''. Then we can see the geometry in the GUI.  
    \item In the selection manual under the ``File'' button, select ``Mesh'' group to show available commands for generating mesh. Press ``Tools$->$Options$->$Mesh$->$General'' to define the minimum element size and maximum element size (numbers in unit of meter) and close the ``Options'' tag.
    \item Press ``3D'' button in ``Mesh'' command group to start meshing, if the meshing is done, press ``File$->$Save Mesh'' to store the mesh to file ``10.msh'' and use an editor like ``Emacs'' to open the file ``10.msh''. Change the second line ``2.1 0 8'' to `` 2 0 8'' and save.
    \item Copy the c++ executable ``gmsh2femaxxhdf5'', developed by Dr. Benedikt originally for the finite element solver FEMAXX, to current folder and type:\\
./gmsh2femaxxhdf5 -~-gmsh-input-filename 10.msh -~-femaxx-output-filename 10.h5
\end{enumerate}

Then we get the FEMAXX hdf5 file ``10.h5'', this file contains both the surface mesh (which we need in \opal ) and the volume mesh (which we don't need in \opal ). The ``BoundaryGeometry'' class in \opal\ can read in the surface mesh in ``10.h5''.\\

For a simple geometry like cuboid box for parallel plates benchmark simulation, instead of reading in a STEP format geometry, we can even directly write the geometry into GMSH readable geometry file named in ``.geo'' suffix. For example the geometry file used to benchmark Vaughan's secondary emission model in \opal, ``pplate\_1mm.geo'', can be directly written as:
\begin{verbatim}
Point(1) = {0, 0, 0};
Point(2) = {0, 0, 0.001};
Point(3) = {0.01, 0, 0.0};
Point(4) = {0.01, 0, 0.001};
Point(5) = {0.01, 0.01, 0.001};
Point(6) = {0.0, 0.01, 0.001};
Point(7) = {0.0, 0.01, 0.0};
Point(8) = {0.01, 0.01, 0.0};
Line(1) = {6, 2};
Line(2) = {7, 1};
Line(3) = {2, 1};
Line(4) = {6, 7};
Line(5) = {3, 4};
Line(6) = {5, 4};
Line(7) = {8, 3};
Line(8) = {5, 8};
Line(9) = {1, 3};
Line(10) = {7, 8};
Line(11) = {5, 6};
Line(12) = {4, 2};
Line Loop(13) = {12, 3, 9, 5};
Plane Surface(14) = {13};
Line Loop(15) = {7, 5, -6, 8};
Plane Surface(16) = {15};
Line Loop(17) = {12, -1, -11, 6};
Plane Surface(18) = {17};
Line Loop(19) = {2, -3, -1, 4};
Plane Surface(20) = {19};
Line Loop(21) = {10, -8, 11, 4};
Plane Surface(22) = {21};
Line Loop(23) = {9, -7, -10, 2};
Plane Surface(24) = {23};
Surface Loop(25) = {18, 14, 20, 24, 16, 22};
Volume(26) = {25};
\end{verbatim}
The unit of coordinates in the above file is meter. The line segments are defined by the ID of their vertex. The plane surfaces are defined by the ID of their edges. The volume is defined by the ID of its surfaces. Then we can use the GMSH to open the geometry file ``pplate\_1mm.geo'' instead of ``.stp'' file and generate the mesh follow the above mentioned process.
\section{Prepare the Field Maps}
New field map ``FM3DH5Block\_nonescale" has almost the same format as the existing type ``FM3DH5Block", i.e., also has both ``Efield" and ``Hfield" data sets and reads field map in ``MV/m". The only difference is that the ``FM3DH5Block\_nonescale" format don't use the $E_{zmax}$ to scale the field map and user should set the ``VOLT" command in the definition of ``RFCavity" element to 1 in the iput file.  

A new element type ``CYCLOTRONVALLEY", as well as two new field map type ``FM3DMagnetoStaticH5Block" has been implemented in \opal\ to model the multipacting of cyclotron cavities which is mounted in the valley of a cyclotron. 

The new element ``CYCLOTRONVALLEY" contains 4 own commands ``FMAPFN", ``DX", ``DY" and ``DZ" which denote the field map file name, the displacement in $\mathbf{x}$, $\mathbf{y}$ and $\mathbf{z}$ direction, respectively and 1 common command ``ELEMEDGE" which denote the start point of the element in $\mathbf{z}$ direction.

New field map ``FM3DMagnetoStaticH5Block" also has both ``Efield" and ``Bfield" data sets, however, the electric field parts are zero. This could maintain the same pattern of ``apply" method in ``CYCLOTRONVALLEY" element as in other elements in \opal. The ``Bfield" data should be in ``Gauss", and the ``FM3DMagnetoStaticH5Block" will convert the ``Bfield" data into ``Tesla". The field map will vary first in $\mathbf{x}$, then in $\mathbf{y}$ and finally in $\mathbf{z}$ direction.

The above new field map formats are all based on the H5Block library within H5Part package. The example C codes to convert a ASCII field map to above new field map formats, as well as the ASCII field maps are also listed in the same folder as this documentation.
\section{Prepare the Input File}
\subsection{Dark current example}
\subsection{Multipacting example}
\begin{verbatim}
Title, string="Cyclotron_Multipacting_Simulation_example";

Option, TFS=FALSE;
Option, ECHO=FALSE;
Option, INFO=FALSE;

Option, PSDUMPFREQ=1;
Option, STATDUMPFREQ=1;
Option, PPDEBUG=FALSE;
Option, SURFDUMPFREQ=100;

// Set an upper limit of simulation particle number 
// to prevent memory overflow. 

MAXPARTSNUM=1000000;

// SECONDARYFLAG = 1: Using Furman-Pivi's model
// SURFMATERIAL=0: surface material is copper 
// Set NEMISSIONMODE=false will use re-normalize 
// simulation particle approach. 
// Set the field enhancement factor FNBETA to 
// a very small number to prevent field 
// emission.

DistSurf: DISTRIBUTION, DISTRIBUTION = "SURFACEEMISSION", 
                        NPDARKCUR =0,INWARDMARGIN = 0.0, 
                        FNBETA = 0.1, FNMAXEMI = 2,  
                        SECONDARYFLAG = 1, 
                        NEMISSIONMODE=false, 
                        SURFMATERIAL=0; 

// INWARDMARGIN: seed electron positions along the 
// inward normal w.r.t the boundary surface.
DistSurf1: DISTRIBUTION, 
           DISTRIBUTION = "SURFACERANDCREATE",
           INWARDMARGIN = 0.0, NPDARKCUR =10000, 
           EINITHR = 0.2; 

// For multipacting study of cyclotron cavity, 
// the axis z in geometry file is actually axis y 
// in ParallelTTracker, so we need to shift z 
// coordinates of the geometry by specifying ZSHIFT to make 
// sure that the z coordinates read in by ParallelTTracker 
// will be correct.
						    
ge: GEOMETRY, FGEOM="../10.h5", S=0.0, 
       ZSHIFT=0.631, DISTRS={DistSurf, DistSurf1};

Box: RFCavity, PLENGTH = 1.262, VOLT = 1, 
               GEOMETRY = ge, FMAPFN = "../CyciaeEM.h5",
	       ELEMEDGE =0, FAST=true, 
               FREQ =44.6, LAG = 0.0, 
               DX = 0, DY = 0, DZ = 0;

// This element is used to model the magnetic field in 
// the valley of a cyclotron, where the RF cavity is installed.
 
Mag: CYCLOTRONVALLEY, FMAPFN = "../CyciaeMagReal.h5", 
                      ELEMEDGE =0,DX = 0, DY = 0, DZ = 0;

Benchmark: Line = (Box, Mag);

Fs1:FIELDSOLVER, FSTYPE = NONE, MX = 32, 
                 MY = 32, MT = 256,
		 PARFFTX = true, PARFFTY = true, 
                 PARFFTT = false, BCFFTX = open, 
                 BCFFTY = open, BCFFTT = open,
		 BBOXINCR = 0.1, GREENSF = INTEGRATED;
		 
qb=0.2e-9;
bfreq=300;
bcurrent=qb*bfreq;

beam1: BEAM, PARTICLE = ELECTRON, pc = P0, 
             NPART = 2000, BFREQ = bfreq , 
             BCURRENT = bcurrent, CHARGE =-1;

Select, Line=Benchmark;

track, line= Benchmark, beam=beam1, 
       MAXSTEPS=23000, DT=4e-12, ZSTOP=3;  

run, method = "PARALLEL-T", beam = beam1, 
     fieldsolver = Fs1, MULTIPACTING=true;
endtrack;

Quit;

\end{verbatim}
\subsection{Parallel Plate Benchmark example}
\begin{verbatim}
Option, TFS=FALSE;
Option, ECHO=FALSE;
Option, PSDUMPFREQ=1;
Option, STATDUMPFREQ=1;
Option, INFO=TRUE;
//======================================================================
// Set the parallel plate flag to be true. 
// In benchmark, the secondary emission model, the  
// emission angle and energy are with 1D distribution,  
// the same with the non-stationary theory.
//  
Option, PPDEBUG=TRUE; 
//======================================================================

Title, string="Benchmark";


Phi              = 0;    
ppvolt           = 0.00012; // MV
pplength         = 0.001;   // m
ppfreq           = 1640;    // Hz

//======================================================================

DistSurf: DISTRIBUTION, DISTRIBUTION = "SURFACEEMISSION", 
          NPDARKCUR =0, FNBETA = 0.1, FNMAXEMI = 2, 
          SECONDARYFLAG = 2, NEMISSIONMODE=true, VSEYZERO=0.5, 
          VEZERO=12.5, VSEYMAX=2.22, VEMAX=165.0, 
          VKENERGY=1.0, VKTHETA=1.0, 
          VW=1.6e-19*ppvolt*1e6/9.10938188/1e-31/2/3.1415926/ppfreq/1e6/pplength, 
          VVTHERMAL=7.268929821*1e5, SURFMATERIAL=0; 
// Seed electrons 
DistSurf1: DISTRIBUTION, DISTRIBUTION = "SURFACERANDCREATE",
           INWARDMARGIN = 0.0, NPDARKCUR =2000, 
           VW=1.6e-19*ppvolt*1e6/9.10938188/1e-31/2/3.1415926/ppfreq/1e6/pplength, 
           VVTHERMAL=7.268929821*1e5; // randomly generate more electrons

ge: GEOMETRY, FGEOM="../pplate_1mm.h5", 
    S=0.0,ZSHIFT=0, DISTRS={DistSurf, DistSurf1};


value,{Phi};

//=======================================================================
// L:		physical element length (real in m)
// VOLT:	the voltage between the parallel plate
// ELEMEDGE:	physical start of the element on the floor (real in m)
// FREQ:	RF frequency of cavity (real in MHz).

Box: PARALLELPLATE, PLENGTH = pplength, VOLT = ppvolt, 
     GEOMETRY = ge, ELEMEDGE =0, FREQ =ppfreq, 
     LAG = Phi, DX = 0, DY = 0, DZ = 0;

Benchmark: Line = (Box);



// Begin: Fieldsolver ///////////////////////////////////////////
//
// Definition of first field solver.
//
Fs1:FIELDSOLVER, FSTYPE = NONE, MX = 32, MY = 32, MT = 128,
		 PARFFTX = true, PARFFTY = true, PARFFTT = false,
		 BCFFTX = open, BCFFTY = open, BCFFTT = open,
		 BBOXINCR = 1, GREENSF = INTEGRATED;
// End: Fieldsolver ////////////////////////////////////////////




Dist3:DISTRIBUTION, DISTRIBUTION = "SURFACERAND"; 

qb=0.2e-9;
bfreq=300;
bcurrent=qb*bfreq;

beam1: BEAM, PARTICLE = ELECTRON, pc = P0, 
       NPART = 3000, BFREQ = bfreq , 
       BCURRENT = bcurrent, CHARGE = -1;

Select, Line=Benchmark;

track, line= Benchmark, beam=beam1, 
       MAXSTEPS=2500, DT=2e-12, ZSTOP=0.9;  
 run, method = "PARALLEL-T", beam = beam1, fieldsolver = Fs1, 
      distribution =Dist3, MULTIPACTING=true;
endtrack;


Quit;
\end{verbatim}
\section{Post Processing}
In the general case (not only in boundary geometry related simulations), \opal will dump the $6$D phase space and statistical information of the particles in the simulation domain, into a {\tt h5} file. The dump frequency, i.e., after how many time steps the particle information will be saved can be specified with the option {\tt PSDUMPFREQ}. Setting {\tt Option, PSDUMPFREQ=1} dumps the information in each time step. 

A utility tool {\tt h5ToVtk}  converts the {\tt h5} file to the Visualization Toolkit (VTK) legacy format. The number of VTK files equals to the number of time steps in {\tt h5} file. These VTK files together with a VTK file automatically generated by the geometry class of \opal which contains the geometry of the RF structure under study can be visualized using for example with Paraview \cite{paraview}. The animation and clip feature of Paraview is very useful to visualize the particle motion inside the RF structure. 

For simulations involving the geometry (multipacting and field emission), \opal will also dump the position and current of incident particles into another {\tt h5} file with the name {\tt *\_Surface.h5}, where the asterisk stands for the base name of the user's \opal input file. The dump frequency can be specified in the option {\tt SURFDUMPFREQ} in the \opal input file. Another utility tool {\tt h5SurfaceVtk}  convert the {\tt *\_Surface.h5}  file to VTK files. For multipacting simulation, these VTK files can be used to visualize the {\em hot spots} of the RF structure where multipacting happens. 

The above mentioned utility tools are based on H5hut library, and will soon be available in the distribution.

Some of the boundary geometry related simulations, like the multipacting simulation using re-normalizing particle number approach, or dark current simulations where the current of field emitted particles from a single triangle has been re-normalized as the model predicted current has exceeded the user defined upper limit, the current (weight) of simulation particles varies and each simulation particle stands for more physical particles than the initial simulation particles. In these cases, instead of using simulation particles, we count the number of {\em effective particles} defined as the ratio of total current in simulation over the current of a single initial particle.

An ASCII file named {\tt Part\_statistics.dat} containing the simulation time, the number of impacts and associated total SEY value as well as the number of {\em effective particles} in each time step. This makes the analysis of the time evolution of particle density feasible with  tools like GNUPLOT. 
\begin{thebibliography}{99}
\bibitem{heronion} Benedikt Oswald, Heronion - a graphical user interface (GUI) based frontend program for electrodynamics calculation developed at PSI, 2007-2011
\bibitem{tetgen} Hang Si, TetGen - A Quality Tetrahedral Mesh Generator and a 3D Delaunay Triangulator, \url{http://tetgen.berlios.de/} 
\bibitem{gmsh} Christophe Geuzaine and Jean-Fran{\c c}ois Remacle,

Gmsh: a three-dimensional finite element mesh generator with built-in
  pre- and post-processing facilities. Submitted to the "International Journal for Numerical Methods in 
Engineering", 2008. \url{http://geuz.org/gmsh/}
\bibitem{paraview} A. Henderson, ParaView Guide: A Parallel Visualization Application, Kitware Inc., 2007  
\end{thebibliography} 
\end{document}
